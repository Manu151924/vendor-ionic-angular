<ion-content>
  <ion-card class="custom-card">
    <div class="header-row">
      <ion-item lines="none" class="custom-dropdown">
        <ion-icon name="location" slot="start" color="success"></ion-icon>
        <ion-select [formControl]="selectedCityControl" interface="popover" class="header-dropdown">
          @for(city of cities; track cities){
          <ion-select-option  [value]="city">
            {{ city }}
          </ion-select-option>
          }
        </ion-select>
      </ion-item>

      <ion-note color="dark" class="header-note">
        WAYBILLS: 330PKGS : 670WT. (Ton) : 16
      </ion-note>
    </div>

    <div class="subtitle">AVL. INVENTORY</div>
    <div class="side-label">DLV. ROUTE WISE WB COUNT</div>

    <ngx-charts-bar-horizontal
      [results]="barData$ | async"
      [scheme]="colorScheme"
      [view]="[310,150]"
      [roundEdges]="true"
      [barPadding]="10">
    </ngx-charts-bar-horizontal>

    <div class="footer-label">{{ form.get('selectedCity')?.value }}</div>
  </ion-card>

  <div class="status-bar-row">
    <div class="status-pill">
      OFD: 330 | DELIVERED: 170 / PKG.400 / WT. 3 Ton
      <span class="undelivered-label">UN-DELIVERED: 120</span>
    </div>

    <ion-button class="today-btn" fill="solid" color="success" (click)="openCalendar()">
      {{ displayDate }}
      <ion-icon name="calendar" slot="end"></ion-icon>
    </ion-button>
  </div>

  <div class="dashboard-container">
    <div class="table-card">
      <div class="row-flex">
        <div class="left-col">
          @if(tripVehicles$ | async; as vehicles ){
          <ng-container>
            <app-trip-status-table
              [vehicles]="vehicles | slice:0:displayedLimit"
              [total]="vehicles.length">
            </app-trip-status-table>
          </ng-container>
          }@else{
            <ion-text color="medium">No trips available.</ion-text>
          }
        </div>

        <div class="right-col">
          @if(absentVehicles$ | async ; as vehicles){
          <ng-container>
            <app-absent-vehicle-list
              [vehicles]="vehicles | slice:0:displayedLimit"
              [total]="vehicles.length">
            </app-absent-vehicle-list>
          </ng-container>
          }@else {
             <ion-text color="medium">No absent vehicles found.</ion-text>
          }
        </div>
      </div>

      <div class="expand-indicator" (click)="toggleExpansion()">
        <ion-icon [name]="isExpanded ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
      </div>
    </div>
  </div>

  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-main red">â‚¹ 52,348.00</div>
      <div class="kpi-label">To Be Collected <span class="mini">(As on)</span></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon-bg">
        <ion-icon name="document"></ion-icon>
        <div class="kpi-main">3</div>
      </div>
      <div class="kpi-label">Pending POD's <span class="mini">(As on)</span></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon-bg">
        <ion-icon name="car-outline"></ion-icon>
        <div class="kpi-main">3</div>
      </div>
      <div class="kpi-label">Market Vehicle Usage <span class="mini">(Today)</span></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon-bg">
        <ion-icon name="shield-checkmark"></ion-icon>
        <div class="kpi-main green">76%</div>
      </div>
      <div class="kpi-label">Safedrop Usage <span class="mini">(Today)</span></div>
    </div>
  </div>

  <ion-card class="snapshot-card">
    <div class="snapshot-header">
      <span class="snapshot-title">Month Wise Snapshot</span>
      <ion-button class="snapshot-dropdown" fill="solid" color="success" size="small" (click)="openMonthPicker()">
        {{ formatMonth(form.get('selectedMonth')?.value) }}
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
      </ion-button>
    </div>
      <mat-form-field style="display: none;">
        <input matInput  
          [matDatepicker]="monthPicker"
          [min]="minDate"
          [max]="maxDate"
          [value]="selectedMonth"
          readonly>
      </mat-form-field>
      <mat-datepicker #monthPicker startView="multi-year" panelClass="month-picker" (monthSelected)="chosenMonthHandler($event, monthPicker)">
      </mat-datepicker>
    <div class="snapshot-content">
      <div class="donut-section">
        <app-pie-chart [data]="(pieChartData$ | async) ?? []" [view]="[120,120]"></app-pie-chart>
        <div class="donut-legend">
          <div>
            <span class="delivered-label">Delivered</span>
            <span class="donut-stats">WB: 370<br/>Wt.: 16 Ton</span>
          </div>
          <div>
            <span class="undelivered-label">Un-Delivered</span>
            <span class="donut-stats">WB: 20<br/>Wt.: 1 Ton</span>
          </div>
        </div>
      </div>

      <div class="snapshot-bars">
        <!-- simplified static bars; replace with dynamic values as needed -->
        <div class="bar-section">
          <div class="bar-label-row"><span class="bar-title">Vehicle Attendance</span></div>
          <div class="bar-bg"><div class="bar-fill attendance"></div></div>
        </div>
        <div class="bar-section">
          <div class="bar-label-row"><span class="bar-title">Safedrop Usage</span></div>
          <div class="bar-bg"><div class="bar-fill safedrop"></div></div>
        </div>
        <div class="bar-section">
          <div class="bar-label-row"><span class="bar-title">Market Vehicle Usage</span></div>
          <div class="bar-bg"><div class="bar-fill market"></div></div>
        </div>
      </div>
    </div>
  </ion-card>

  <app-progress-slider [value]="progressValue" (valueChange)="onProgressChange($event)"></app-progress-slider>
</ion-content>

<ion-modal [isOpen]="calendarOpen">
  <ng-template>
    <ion-content>
      <div class="calendar-container">
        <mat-calendar
          [selected]="tempSelectedDate"
          [minDate]="minDate"
          [maxDate]="maxDate"
          (selectedChange)="onDateSelect($event)">
        </mat-calendar>
      </div>
    </ion-content>

    <ion-footer>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancelDate()">Cancel</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="confirmDate()">OK</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>
